<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Scripts - PLC Monitor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .scripts-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .script-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .script-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .script-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin: 0;
        }
        
        .script-description {
            color: #666;
            font-size: 14px;
            margin: 5px 0 0 0;
        }
        
        .script-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .script-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-enabled {
            color: #28a745;
        }
        
        .status-disabled {
            color: #dc3545;
        }
        
        .script-body {
            padding: 20px;
        }
        
        .script-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .info-section h4 {
            margin: 0 0 10px 0;
            color: #555;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .gpio-pins {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .gpio-pin {
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .script-code {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            overflow-x: auto;
            white-space: pre;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .script-results {
            background: #e8f5e8;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            padding: 10px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .script-results.error {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
            transition: background-color 0.2s;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-toggle {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-toggle:hover {
            background: #e0a800;
        }
        
        .page-header {
            background: #007bff;
            color: white;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 8px;
        }
        
        .page-header h1 {
            margin: 0;
            font-size: 28px;
        }
        
        .page-header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }
        
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .toolbar-left {
            display: flex;
            gap: 10px;
        }
        
        .status-summary {
            display: flex;
            gap: 20px;
            font-size: 14px;
        }
        
        .summary-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .summary-value {
            font-weight: bold;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .nav-links {
            margin-bottom: 20px;
        }
        
        .nav-links a {
            color: #007bff;
            text-decoration: none;
            margin-right: 15px;
        }
        
        .nav-links a:hover {
            text-decoration: underline;
        }
        
        .collapsible {
            cursor: pointer;
            user-select: none;
        }
        
        .collapsible:hover {
            background: #f0f0f0;
        }
        
        .script-content {
            display: none;
        }
        
        .script-content.expanded {
            display: block;
        }
        
        .expand-icon {
            transition: transform 0.2s;
        }
        
        .expand-icon.expanded {
            transform: rotate(90deg);
        }
    </style>
</head>
<body>
    <div class="scripts-container">
        <div class="nav-links">
            <a href="/">‚Üê Back to PLC Monitor</a>
            <a href="#help" onclick="showHelp()">üìñ Script Help & Examples</a>
        </div>
        
        <div class="page-header">
            <h1>üîß Custom Scripts Manager</h1>
            <p>Control GPIO pins and manipulate Modbus bits with user-programmable automation scripts</p>
        </div>
        
        <div class="toolbar">
            <div class="toolbar-left">
                <button class="btn btn-primary" onclick="refreshScripts()">üîÑ Refresh</button>
                <button class="btn btn-success" onclick="createNewScript()">+ New Script</button>
                <button class="btn btn-secondary" onclick="toggleAllScripts()">Toggle All</button>
            </div>
            <div class="status-summary">
                <div class="summary-item">
                    <span>Total Scripts:</span>
                    <span class="summary-value" id="totalScripts">0</span>
                </div>
                <div class="summary-item">
                    <span>Enabled:</span>
                    <span class="summary-value status-enabled" id="enabledScripts">0</span>
                </div>
                <div class="summary-item">
                    <span>Disabled:</span>
                    <span class="summary-value status-disabled" id="disabledScripts">0</span>
                </div>
            </div>
        </div>
        
        <div id="errorMessage" class="error-message" style="display: none;"></div>
        
        <div id="scriptsContainer">
            <div class="loading">
                <p>Loading scripts...</p>
            </div>
        </div>
        
        <!-- Help Modal -->
        <div id="helpModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; max-width: 900px; max-height: 90%; overflow-y: auto; padding: 0;">
                <div style="background: #007bff; color: white; padding: 20px; border-radius: 8px 8px 0 0;">
                    <h2 style="margin: 0;">üìñ Custom Scripts Help & Examples</h2>
                    <button onclick="hideHelp()" style="position: absolute; top: 15px; right: 20px; background: none; border: none; color: white; font-size: 24px; cursor: pointer;">√ó</button>
                </div>
                <div style="padding: 30px;">
                    <div class="help-content">
                        <h3>Getting Started</h3>
                        <p>Custom scripts allow you to create automation logic that combines PLC data with GPIO control. Each script runs in a secure environment with access to PLC inputs/outputs and GPIO pins.</p>
                        
                        <h3>Script Structure</h3>
                        <p>Every script must have an <code>execute</code> function that receives three parameters:</p>
                        <div class="script-code">def execute(plc_data, gpio, script_state):
    # Your automation logic here
    return {"status": "Script completed", "message": "Optional details"}</div>
                        
                        <h4>Parameters Explained:</h4>
                        <ul>
                            <li><strong>plc_data</strong> - Dictionary containing current PLC status</li>
                            <li><strong>gpio</strong> - GPIO controller for pin manipulation</li>
                            <li><strong>script_state</strong> - Persistent storage between script executions</li>
                        </ul>
                        
                        <h3>Available PLC Data</h3>
                        <div class="script-code"># Digital Inputs (X000-X015)
x001_active = plc_data.get('input_status', {}).get('X001', False)
x005_status = plc_data.get('input_status', {}).get('X005', False)

# Digital Outputs/Coils (Y000-Y015)
y003_status = plc_data.get('coil_status', {}).get('Y003', False)

# Data Registers (DS001-DS010)
register_value = plc_data.get('data_registers', {}).get('DS001', 0)
temperature = plc_data.get('data_registers', {}).get('DS005', 0)</div>
                        
                        <h3>GPIO Control</h3>
                        <div class="script-code"># Set GPIO pin high/low
gpio.set_pin(18, True)   # Turn GPIO 18 ON
gpio.set_pin(19, False)  # Turn GPIO 19 OFF

# Read GPIO pin state
pin_state = gpio.get_pin(20)

# Control PLC coils (outputs)
gpio.write_coil(5, True)    # Set Y005 to ON
gpio.write_coil(10, False)  # Set Y010 to OFF

# Write to PLC registers
gpio.write_register(1, 100)  # Set DS001 to 100</div>
                        
                        <h3>Using Script State</h3>
                        <p>Script state persists between executions, perfect for timers and counters:</p>
                        <div class="script-code"># Initialize counter on first run
if 'counter' not in script_state:
    script_state['counter'] = 0

# Increment counter
script_state['counter'] += 1

# Timer example
import time
current_time = time.time()
if 'last_action' not in script_state:
    script_state['last_action'] = current_time

# Check if 10 seconds have passed
if current_time - script_state['last_action'] > 10:
    # Do something every 10 seconds
    script_state['last_action'] = current_time</div>
                        
                        <h3>Example Scripts</h3>
                        
                        <h4>1. Safety Interlock</h4>
                        <div class="script-code">def execute(plc_data, gpio, script_state):
    # Emergency stop logic
    emergency_stop = plc_data.get('input_status', {}).get('X000', False)
    door_closed = plc_data.get('input_status', {}).get('X001', False)
    
    # Only allow machine to run if door is closed and no emergency stop
    machine_enable = door_closed and not emergency_stop
    
    # Control machine enable relay
    gpio.write_coil(0, machine_enable)  # Y000 = Machine Enable
    
    # Turn on warning light if unsafe
    gpio.set_pin(18, not machine_enable)
    
    return {
        "status": f"Machine {'ENABLED' if machine_enable else 'DISABLED'}",
        "emergency_stop": emergency_stop,
        "door_closed": door_closed
    }</div>
                        
                        <h4>2. Temperature Control</h4>
                        <div class="script-code">def execute(plc_data, gpio, script_state):
    # Read temperature from PLC register
    temperature = plc_data.get('data_registers', {}).get('DS001', 0)
    
    # Temperature setpoint
    setpoint = 75.0
    hysteresis = 2.0
    
    # Get current heater state
    if 'heater_on' not in script_state:
        script_state['heater_on'] = False
    
    # Hysteresis control logic
    if temperature < (setpoint - hysteresis):
        script_state['heater_on'] = True
    elif temperature > (setpoint + hysteresis):
        script_state['heater_on'] = False
    
    # Control heater output
    gpio.write_coil(5, script_state['heater_on'])  # Y005 = Heater
    
    # Status LED
    gpio.set_pin(19, script_state['heater_on'])
    
    return {
        "status": f"Temp: {temperature}¬∞F, Heater: {'ON' if script_state['heater_on'] else 'OFF'}",
        "temperature": temperature,
        "setpoint": setpoint
    }</div>
                        
                        <h4>3. Production Counter</h4>
                        <div class="script-code">def execute(plc_data, gpio, script_state):
    # Part detection sensor
    part_detected = plc_data.get('input_status', {}).get('X002', False)
    
    # Initialize counters
    if 'total_parts' not in script_state:
        script_state['total_parts'] = 0
        script_state['last_detection'] = False
    
    # Count on rising edge (part detected)
    if part_detected and not script_state['last_detection']:
        script_state['total_parts'] += 1
        
        # Flash counter LED
        gpio.set_pin(20, True)
        
        # Write count to PLC register
        gpio.write_register(10, script_state['total_parts'])
    
    # Turn off LED after detection
    if not part_detected:
        gpio.set_pin(20, False)
    
    script_state['last_detection'] = part_detected
    
    return {
        "status": f"Parts counted: {script_state['total_parts']}",
        "part_detected": part_detected,
        "total_parts": script_state['total_parts']
    }</div>
                        
                        <h4>4. Scheduled Operations</h4>
                        <div class="script-code">def execute(plc_data, gpio, script_state):
    import time
    current_time = time.time()
    
    # Initialize timing
    if 'cycle_start' not in script_state:
        script_state['cycle_start'] = current_time
        script_state['step'] = 0
    
    elapsed = current_time - script_state['cycle_start']
    
    # 30-second automation cycle
    if script_state['step'] == 0 and elapsed > 0:
        # Step 1: Start process (0-10 seconds)
        gpio.write_coil(1, True)   # Start pump
        gpio.set_pin(21, True)     # Process indicator
        script_state['step'] = 1
        
    elif script_state['step'] == 1 and elapsed > 10:
        # Step 2: Mix phase (10-20 seconds)
        gpio.write_coil(2, True)   # Start mixer
        script_state['step'] = 2
        
    elif script_state['step'] == 2 and elapsed > 20:
        # Step 3: Complete cycle (20-30 seconds)
        gpio.write_coil(1, False)  # Stop pump
        gpio.write_coil(2, False)  # Stop mixer
        script_state['step'] = 3
        
    elif script_state['step'] == 3 and elapsed > 30:
        # Reset for next cycle
        gpio.set_pin(21, False)    # Turn off indicator
        script_state['cycle_start'] = current_time
        script_state['step'] = 0
    
    return {
        "status": f"Cycle step {script_state['step']}, elapsed: {elapsed:.1f}s",
        "step": script_state['step'],
        "elapsed_time": elapsed
    }</div>
                        
                        <h3>Best Practices</h3>
                        <ul>
                            <li><strong>Keep scripts simple</strong> - Complex logic should be broken into multiple scripts</li>
                            <li><strong>Handle errors gracefully</strong> - Scripts should not crash the system</li>
                            <li><strong>Use descriptive names</strong> - Choose clear script IDs and names</li>
                            <li><strong>Document your logic</strong> - Add comments explaining what your script does</li>
                            <li><strong>Test thoroughly</strong> - Use manual execution to verify script behavior</li>
                            <li><strong>Monitor script results</strong> - Check the results panel for script output</li>
                        </ul>
                        
                        <h3>GPIO Pin Configuration</h3>
                        <p>Specify which GPIO pins your script uses in the "GPIO Pins" field when creating/editing scripts. This helps with documentation and prevents conflicts.</p>
                        
                        <div style="background: #e8f5e8; border: 1px solid #c3e6cb; border-radius: 4px; padding: 15px; margin: 20px 0;">
                            <strong>üí° Pro Tip:</strong> Start with the provided examples and modify them for your specific needs. The timer and GPIO examples are great starting points for most automation tasks.
                        </div>
                        
                        <div style="text-align: center; margin-top: 30px;">
                            <button class="btn btn-primary" onclick="hideHelp()">Got it!</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let scripts = {};
        let scriptResults = {};
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadScripts();
            loadScriptResults();
            
            // Auto-refresh every 5 seconds
            setInterval(loadScriptResults, 5000);
        });
        
        async function loadScripts() {
            try {
                const response = await fetch('/api/scripts');
                const data = await response.json();
                
                if (data.success) {
                    scripts = data.scripts;
                    renderScripts();
                    updateSummary();
                } else {
                    showError('Failed to load scripts: ' + data.error);
                }
            } catch (error) {
                showError('Error loading scripts: ' + error.message);
            }
        }
        
        async function loadScriptResults() {
            try {
                const response = await fetch('/api/scripts/results');
                const data = await response.json();
                
                if (data.success) {
                    scriptResults = data.results;
                    updateScriptResults();
                }
            } catch (error) {
                console.warn('Could not load script results:', error);
            }
        }
        
        function renderScripts() {
            const container = document.getElementById('scriptsContainer');
            
            if (Object.keys(scripts).length === 0) {
                container.innerHTML = `
                    <div class="loading">
                        <p>No custom scripts found. Create your first script to get started!</p>
                        <button class="btn btn-primary" onclick="createNewScript()">Create New Script</button>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            for (const [scriptId, script] of Object.entries(scripts)) {
                const statusClass = script.enabled ? 'status-enabled' : 'status-disabled';
                const statusText = script.enabled ? 'ENABLED' : 'DISABLED';
                const gpioPins = script.gpio_pins.map(pin => `<span class="gpio-pin">GPIO ${pin}</span>`).join('');
                
                html += `
                    <div class="script-card">
                        <div class="script-header collapsible" onclick="toggleScript('${scriptId}')">
                            <div>
                                <h3 class="script-title">
                                    <span class="expand-icon" id="icon-${scriptId}">‚ñ∂</span>
                                    ${escapeHtml(script.name)}
                                </h3>
                                <p class="script-description">${escapeHtml(script.description)}</p>
                            </div>
                            <div class="script-controls">
                                <div class="script-status ${statusClass}">${statusText}</div>
                                <button class="btn btn-toggle" onclick="event.stopPropagation(); toggleScriptEnabled('${scriptId}')">${script.enabled ? 'Disable' : 'Enable'}</button>
                                <button class="btn btn-primary" onclick="event.stopPropagation(); executeScript('${scriptId}')">‚ñ∂ Run</button>
                                <button class="btn btn-secondary" onclick="event.stopPropagation(); editScript('${scriptId}')">‚úè Edit</button>
                                <button class="btn btn-danger" onclick="event.stopPropagation(); deleteScript('${scriptId}')">üóë Delete</button>
                            </div>
                        </div>
                        <div class="script-content" id="content-${scriptId}">
                            <div class="script-body">
                                <div class="script-info">
                                    <div class="info-section">
                                        <h4>GPIO Pins</h4>
                                        <div class="gpio-pins">
                                            ${gpioPins || '<span style="color: #666;">None</span>'}
                                        </div>
                                    </div>
                                    <div class="info-section">
                                        <h4>Status</h4>
                                        <div class="script-status ${statusClass}">${statusText}</div>
                                    </div>
                                </div>
                                <div class="script-results" id="results-${scriptId}" style="display: none;"></div>
                                <details>
                                    <summary style="cursor: pointer; margin-bottom: 10px;">View Code</summary>
                                    <div class="script-code" id="code-${scriptId}">Loading...</div>
                                </details>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            
            // Load detailed script information
            for (const scriptId of Object.keys(scripts)) {
                loadScriptDetail(scriptId);
            }
        }
        
        async function loadScriptDetail(scriptId) {
            try {
                const response = await fetch(`/api/scripts/${scriptId}`);
                const data = await response.json();
                
                if (data.success) {
                    const codeElement = document.getElementById(`code-${scriptId}`);
                    if (codeElement) {
                        codeElement.textContent = data.script.code;
                    }
                }
            } catch (error) {
                console.warn(`Could not load script details for ${scriptId}:`, error);
            }
        }
        
        function updateScriptResults() {
            for (const [scriptId, script] of Object.entries(scripts)) {
                const resultsElement = document.getElementById(`results-${scriptId}`);
                if (resultsElement && scriptResults[scriptId]) {
                    const result = scriptResults[scriptId];
                    const isError = result.error || false;
                    
                    resultsElement.className = `script-results ${isError ? 'error' : ''}`;
                    resultsElement.style.display = 'block';
                    resultsElement.innerHTML = `
                        <strong>Last Result:</strong><br>
                        ${escapeHtml(JSON.stringify(result, null, 2))}
                    `;
                }
            }
        }
        
        function toggleScript(scriptId) {
            const content = document.getElementById(`content-${scriptId}`);
            const icon = document.getElementById(`icon-${scriptId}`);
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                icon.classList.add('expanded');
            }
        }
        
        async function toggleScriptEnabled(scriptId) {
            try {
                const response = await fetch(`/api/scripts/${scriptId}/toggle`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    scripts[scriptId].enabled = data.enabled;
                    renderScripts();
                    updateSummary();
                    showSuccess(`Script ${data.enabled ? 'enabled' : 'disabled'} successfully`);
                } else {
                    showError('Failed to toggle script: ' + data.error);
                }
            } catch (error) {
                showError('Error toggling script: ' + error.message);
            }
        }
        
        async function executeScript(scriptId) {
            try {
                const response = await fetch(`/api/scripts/${scriptId}/execute`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    scriptResults[scriptId] = data.result;
                    updateScriptResults();
                    showSuccess('Script executed successfully');
                } else {
                    showError('Failed to execute script: ' + data.error);
                }
            } catch (error) {
                showError('Error executing script: ' + error.message);
            }
        }
        
        function editScript(scriptId) {
            // Simple prompt-based editing (could be enhanced with a modal)
            const script = scripts[scriptId];
            const newCode = prompt('Edit script code:', script.code || '');
            
            if (newCode !== null) {
                updateScript(scriptId, { code: newCode });
            }
        }
        
        async function updateScript(scriptId, updates) {
            try {
                const response = await fetch(`/api/scripts/${scriptId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updates)
                });
                const data = await response.json();
                
                if (data.success) {
                    loadScripts(); // Reload scripts
                    showSuccess('Script updated successfully');
                } else {
                    showError('Failed to update script: ' + data.error);
                }
            } catch (error) {
                showError('Error updating script: ' + error.message);
            }
        }
        
        async function deleteScript(scriptId) {
            if (!confirm(`Are you sure you want to delete script "${scripts[scriptId].name}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/scripts/${scriptId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    delete scripts[scriptId];
                    renderScripts();
                    updateSummary();
                    showSuccess('Script deleted successfully');
                } else {
                    showError('Failed to delete script: ' + data.error);
                }
            } catch (error) {
                showError('Error deleting script: ' + error.message);
            }
        }
        
        function createNewScript() {
            showScriptWizard();
        }
        
        function showScriptWizard() {
            const templates = {
                'basic': {
                    name: 'Basic Template',
                    description: 'Simple script template with examples',
                    code: `# Basic Custom Script
# Add your automation logic here

def execute(plc_data, gpio, script_state):
    # Read PLC inputs
    x001 = plc_data.get('input_status', {}).get('X001', False)
    
    # Control GPIO pin based on input
    gpio.set_pin(18, x001)
    
    # Control PLC output
    gpio.write_coil(5, x001)
    
    return {
        "status": f"X001: {x001}, GPIO18: {x001}",
        "input_active": x001
    }`
                },
                'safety': {
                    name: 'Safety Interlock',
                    description: 'Emergency stop and door safety logic',
                    code: `# Safety Interlock System
# Monitors emergency stop and door sensors

def execute(plc_data, gpio, script_state):
    # Read safety inputs
    emergency_stop = plc_data.get('input_status', {}).get('X000', False)
    door_closed = plc_data.get('input_status', {}).get('X001', False)
    
    # Safety logic: machine can only run if door closed and no e-stop
    machine_safe = door_closed and not emergency_stop
    
    # Control machine enable relay
    gpio.write_coil(0, machine_safe)  # Y000
    
    # Warning light on GPIO
    gpio.set_pin(18, not machine_safe)
    
    return {
        "status": f"Machine {'SAFE' if machine_safe else 'UNSAFE'}",
        "emergency_stop": emergency_stop,
        "door_closed": door_closed,
        "machine_enabled": machine_safe
    }`
                },
                'timer': {
                    name: 'Timer Control',
                    description: 'Time-based automation with delays',
                    code: `# Timer-based Control
# Cycles through operations with timing

def execute(plc_data, gpio, script_state):
    import time
    current_time = time.time()
    
    # Initialize state
    if 'start_time' not in script_state:
        script_state['start_time'] = current_time
        script_state['phase'] = 0
    
    elapsed = current_time - script_state['start_time']
    
    # Phase control (30-second cycle)
    if script_state['phase'] == 0 and elapsed >= 0:
        # Phase 1: Start (0-10s)
        gpio.write_coil(1, True)  # Y001 ON
        gpio.set_pin(19, True)
        script_state['phase'] = 1
        
    elif script_state['phase'] == 1 and elapsed >= 10:
        # Phase 2: Process (10-20s)
        gpio.write_coil(2, True)  # Y002 ON
        script_state['phase'] = 2
        
    elif script_state['phase'] == 2 and elapsed >= 20:
        # Phase 3: Complete (20-30s)
        gpio.write_coil(1, False)  # Y001 OFF
        gpio.write_coil(2, False)  # Y002 OFF
        script_state['phase'] = 3
        
    elif script_state['phase'] == 3 and elapsed >= 30:
        # Reset cycle
        gpio.set_pin(19, False)
        script_state['start_time'] = current_time
        script_state['phase'] = 0
    
    return {
        "status": f"Phase {script_state['phase']}, Time: {elapsed:.1f}s",
        "phase": script_state['phase'],
        "elapsed": elapsed
    }`
                }
            };
            
            let templateOptions = '';
            for (const [key, template] of Object.entries(templates)) {
                templateOptions += `<option value="${key}">${template.name} - ${template.description}</option>`;
            }
            
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001; display: flex; align-items: center; justify-content: center;';
            modal.innerHTML = `
                <div style="background: white; border-radius: 8px; padding: 30px; max-width: 500px; width: 90%;">
                    <h3 style="margin-top: 0;">Create New Script</h3>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Script Name:</label>
                        <input type="text" id="scriptName" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="My Custom Script">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Description:</label>
                        <input type="text" id="scriptDesc" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="What does this script do?">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Template:</label>
                        <select id="scriptTemplate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            ${templateOptions}
                        </select>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="document.body.removeChild(this.closest('div').parentElement)" class="btn btn-secondary">Cancel</button>
                        <button onclick="createScriptFromWizard()" class="btn btn-primary">Create Script</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        async function createScript(scriptId, name, description, code) {
            try {
                const response = await fetch('/api/scripts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: scriptId,
                        name: name,
                        description: description,
                        code: code,
                        enabled: false,
                        gpio_pins: []
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    loadScripts(); // Reload scripts
                    showSuccess('Script created successfully');
                } else {
                    showError('Failed to create script: ' + data.error);
                }
            } catch (error) {
                showError('Error creating script: ' + error.message);
            }
        }
        
        function refreshScripts() {
            loadScripts();
            loadScriptResults();
        }
        
        function toggleAllScripts() {
            const enabledCount = Object.values(scripts).filter(s => s.enabled).length;
            const totalCount = Object.keys(scripts).length;
            
            const shouldEnable = enabledCount < totalCount / 2;
            
            for (const scriptId of Object.keys(scripts)) {
                if (scripts[scriptId].enabled !== shouldEnable) {
                    toggleScriptEnabled(scriptId);
                }
            }
        }
        
        function updateSummary() {
            const total = Object.keys(scripts).length;
            const enabled = Object.values(scripts).filter(s => s.enabled).length;
            const disabled = total - enabled;
            
            document.getElementById('totalScripts').textContent = total;
            document.getElementById('enabledScripts').textContent = enabled;
            document.getElementById('disabledScripts').textContent = disabled;
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        function showSuccess(message) {
            // Simple success notification (could be enhanced)
            const notification = document.createElement('div');
            notification.className = 'script-results';
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '1000';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 3000);
        }
        
        function createScriptFromWizard() {
            const name = document.getElementById('scriptName').value.trim();
            const description = document.getElementById('scriptDesc').value.trim();
            const templateKey = document.getElementById('scriptTemplate').value;
            
            if (!name || !description) {
                alert('Please enter both name and description');
                return;
            }
            
            const templates = {
                'basic': {
                    name: 'Basic Template',
                    description: 'Simple script template with examples',
                    code: `# Basic Custom Script
# Add your automation logic here

def execute(plc_data, gpio, script_state):
    # Read PLC inputs
    x001 = plc_data.get('input_status', {}).get('X001', False)
    
    # Control GPIO pin based on input
    gpio.set_pin(18, x001)
    
    # Control PLC output
    gpio.write_coil(5, x001)
    
    return {
        "status": f"X001: {x001}, GPIO18: {x001}",
        "input_active": x001
    }`
                },
                'safety': {
                    name: 'Safety Interlock',
                    description: 'Emergency stop and door safety logic',
                    code: `# Safety Interlock System
# Monitors emergency stop and door sensors

def execute(plc_data, gpio, script_state):
    # Read safety inputs
    emergency_stop = plc_data.get('input_status', {}).get('X000', False)
    door_closed = plc_data.get('input_status', {}).get('X001', False)
    
    # Safety logic: machine can only run if door closed and no e-stop
    machine_safe = door_closed and not emergency_stop
    
    # Control machine enable relay
    gpio.write_coil(0, machine_safe)  # Y000
    
    # Warning light on GPIO
    gpio.set_pin(18, not machine_safe)
    
    return {
        "status": f"Machine {'SAFE' if machine_safe else 'UNSAFE'}",
        "emergency_stop": emergency_stop,
        "door_closed": door_closed,
        "machine_enabled": machine_safe
    }`
                },
                'timer': {
                    name: 'Timer Control',
                    description: 'Time-based automation with delays',
                    code: `# Timer-based Control
# Cycles through operations with timing

def execute(plc_data, gpio, script_state):
    import time
    current_time = time.time()
    
    # Initialize state
    if 'start_time' not in script_state:
        script_state['start_time'] = current_time
        script_state['phase'] = 0
    
    elapsed = current_time - script_state['start_time']
    
    # Phase control (30-second cycle)
    if script_state['phase'] == 0 and elapsed >= 0:
        # Phase 1: Start (0-10s)
        gpio.write_coil(1, True)  # Y001 ON
        gpio.set_pin(19, True)
        script_state['phase'] = 1
        
    elif script_state['phase'] == 1 and elapsed >= 10:
        # Phase 2: Process (10-20s)
        gpio.write_coil(2, True)  # Y002 ON
        script_state['phase'] = 2
        
    elif script_state['phase'] == 2 and elapsed >= 20:
        # Phase 3: Complete (20-30s)
        gpio.write_coil(1, False)  # Y001 OFF
        gpio.write_coil(2, False)  # Y002 OFF
        script_state['phase'] = 3
        
    elif script_state['phase'] == 3 and elapsed >= 30:
        # Reset cycle
        gpio.set_pin(19, False)
        script_state['start_time'] = current_time
        script_state['phase'] = 0
    
    return {
        "status": f"Phase {script_state['phase']}, Time: {elapsed:.1f}s",
        "phase": script_state['phase'],
        "elapsed": elapsed
    }`
                }
            };
            
            const scriptId = name.toLowerCase().replace(/[^a-z0-9]/g, '_');
            const template = templates[templateKey];
            const code = template.code.replace(/# Basic Custom Script/, `# ${name}`).replace(/# Add your automation logic here/, `# ${description}`);
            
            // Close modal
            const modal = document.querySelector('[style*="z-index: 1001"]');
            if (modal) {
                document.body.removeChild(modal);
            }
            
            createScript(scriptId, name, description, code);
        }
        
        function showHelp() {
            document.getElementById('helpModal').style.display = 'block';
        }
        
        function hideHelp() {
            document.getElementById('helpModal').style.display = 'none';
        }
        
        // Close modals when clicking outside
        document.addEventListener('click', function(event) {
            const helpModal = document.getElementById('helpModal');
            if (event.target === helpModal) {
                hideHelp();
            }
        });
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>